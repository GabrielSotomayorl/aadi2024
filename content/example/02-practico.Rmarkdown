---
title: "2. Visualizaci칩n de datos y correlaci칩n"
linktitle: "2. Visualizaci칩n de datos y correlaci칩n"
date: "2024-08-19"
menu:
  example:
    parent: Ejemplos
    weight: 2
type: docs
toc: true
editor_options:
  chunk_output_type: console
---

## 0. Objetivo del pr치ctico

El objetivo de este pr치ctico es introducir el uso de ggplot para la construcci칩n de visualizaciones de datos en el contexto de an치lisis bivariado, as칤 como la obtenci칩n de estad칤siticos descriptivos y de correlaci칩n con R.

Para esto usaremos datos comunales de registros administrativos y del Censo sobre salarios, educaci칩n y ruralidad para analizar las diferencias territoriales de la brecha salarial de g칠nero. Los datos de registros administrativos en diversos 치mbitos pueden encontrarse en el siguiente enlace <https://observatorio.ministeriodesarrollosocial.gob.cl/rraa-2023>

```{r}
pacman::p_load(dplyr, ggplot2)

datos <- readRDS(url("https://github.com/GabrielSotomayorl/aadi2024/raw/main/content/example/input/data/datos.rds"))  %>% 
  select(comuna,ing_prom_hombre, ing_prom_mujer,prom_esc = promedio_anios_escolaridad25_2017, prop_rural_2020, )


```

Trabajaremos con las siguientes variables:

1.  Comuna
2.  Ingreso promedio de los hombres ocupados formales (RRAA MDSF)
3.  Ingreso promedio de las mujeres ocupados formales (RRAA MDSF)
4.  Promedio de a침os de escolaridad de la poblaci칩n mayor de 25 a침os hasta el a침o 2017 (Censo 2017).
5.  Porcentaje de poblaci칩n rural por comuna (Proyecciones de poblaci칩n INE).

## C치lculo de la brecha salarial

Utilizaremos la brecha salarial media de cada comuna como la variable de inter칠s en nuestro an치lisis. Esta variable es crucial para entender las disparidades de ingresos entre hombres y mujeres a nivel comunal. La brecha salarial media se calcula utilizando la siguiente f칩rmula:

$$  
\frac{\text{Salario Promedio Hombres} - \text{Salario Promedio Mujeres}}{\text{Salario Promedio Hombres}} \times 100
$$

Este c치lculo nos da un porcentaje que representa cu치nto menos ganan, en promedio, las mujeres en comparaci칩n con los hombres en una comuna espec칤fica. Un valor positivo indica que, en promedio, los hombres ganan m치s que las mujeres, mientras que un valor negativo indicar칤a lo contrario (aunque en la pr치ctica, lo com칰n es encontrar valores positivos).

Por ejemplo si en una comuna el salario promedio de los hombres es de \$400.000 y el de las mujeres es 300.000

$$  
\text{Brecha Salarial de G칠nero} = \frac{100.000}{400.000} \times 100 = 0.25 \times 100 = 25\%
$$

Esto significa que, en esta comuna, las mujeres ganan en promedio un 25% menos que los hombres.

Ahora calcularemos esta variable para cada una de las comunas en nuestra base de datos integrando la f칩rmula en el c치lculo de una nueva variable con mutate.

```{r}
datos <- datos %>% 
  mutate(brecha = (ing_prom_hombre - ing_prom_mujer)/ing_prom_hombre*100)
```

## Exploraci칩n de datos y presentaci칩n de tablas

Para obtener una visi칩n general completa de los datos, podemos utilizar la funci칩n dfSummary del paquete summarytools. Esta funci칩n genera un resumen detallado de cada variable en la base de datos, con estad췂siticos descritpivos y una visualici칩n simple.

```{r}
# Instalar y cargar summarytools si no est치 ya instalado
#install.packages("summarytools")
library(summarytools)

# Crear el resumen de los datos y renderizarlo en HTML
resumen <- dfSummary(datos)
print(resumen, headings = FALSE)

```

Para presentar estad칤sticas descriptivas de las variables num칠ricas de manera clara y mejorada visualmente, puedes utilizar kable junto con kableExtra.

```{r, message=FALSE}
# Instalar y cargar knitr y kableExtra si no est치n ya instalados
# install.packages("knitr")
# install.packages("kableExtra")
library(knitr)
library(kableExtra)

# Calcular estad칤sticas descriptivas
descriptivas <- datos %>%
  summarise(
    Minimo = min(brecha, na.rm = TRUE),
    Q1 = quantile(brecha, 0.25, na.rm = TRUE),
    Media = mean(brecha, na.rm = TRUE),
    Mediana = median(brecha, na.rm = TRUE),
    Q3 = quantile(brecha, 0.75, na.rm = TRUE),
    Maximo = max(brecha, na.rm = TRUE),
    DesviacionEstandar = sd(brecha, na.rm = TRUE)
  )

# Mostrar la tabla con kable y kableExtra
descriptivas %>%
  kable("html", caption = "Estad칤sticas Descriptivas de la Brecha Salarial") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

Ahora podemos ver como se agrupan las comunas en distintos niveles de brecha salarial. Para crear una tabla de frecuencias basada en la variable brecha, primero necesitamos recodificar la variable de manera categ칩rica.

```{r}
datos <- datos %>%
  mutate(brecha_recodificada = cut(brecha, breaks = c(-12.8, 0, 12, 24, 36.5),
                                   labels = c("-13% - 0%", "0% - 12%", "12% - 24%", "24% - 36.5%")))

# Generar tabla de frecuencias
frecuencias <- datos %>%
  group_by(brecha_recodificada) %>%
  summarise(Frecuencia = n()) %>%
  mutate(Porcentaje = round((Frecuencia / sum(Frecuencia)) * 100, 2))

# Mostrar la tabla con kable y kableExtra
frecuencias %>%
  kable("html", caption = "Tabla de Frecuencias de la Brecha Salarial Recodificada") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) 
```

## Construcci칩n de gr치ficos con ggplot2

La principal herramienta de visualizaci칩n de datos en R es el paquete ggplot2, que forma parte de tidyverse. ggplot2 implementa la gram치tica de los gr치ficos, un sistema coherente para describir y construir gr치ficos.  
Su versatilidad y capacidad de obtener resultados visualmente atractivos lo hacen m치s pertinente para tareas de presentaci칩n de resultados, tanto a p칰blicos especializados como no especializados.  
Veremos los elementos b치sicos para poder hacer uso del paquete m치s adelante en el contexto de las t칠cnicas estad칤sticas a ver en el curso.

| **Capa**     | **Descripci칩n** |
|--------------|-----------------|
| **Datos**    | Conjunto de informaci칩n que se representar치 de manera gr치fica. En nuestro caso se trata de una o m치s variables, o una base de datos. |
| **Est칠tica** | Escala en la cual se posicionar치 la informaci칩n de inter칠s. Refiere al posicionamiento de la informaci칩n a representar sobre los diferentes ejes y dimensiones del gr치fico resultante. Hablamos del posicionamiento de variables en los ejes X e Y como tambi칠n de la posibilidad de indicar variables que pueden ser posicionadas como color de relleno dentro de los diferentes ejes, como una funci칩n de transparencia, etc. |
| **Geometr칤a**| Formas, elementos visuales, que se emplear치n para representar visualmente la informaci칩n ya consignada en los **datos** y ubicada en las diferentes posiciones del gr치fico mencionadas en la **est칠tica**. Cada especificaci칩n de geometr칤a permite visualizar diferentes caracter칤sticas de la(s) variable(s) y su distribuci칩n. |

En primer lugar tenemos que seleccionar un conjunto de datos sobre el que trabajaremos. Podemos hacer esto de manera integrada con el flujo de trabajo del pipeline que vimos para dplyr. 

```{r,message=FALSE,warning=F}
#install.packages("ggplot2")
library(ggplot2)

datos %>% 
  ggplot() 
```

El resultado de entregar solo una base de datos a ggplot ser치 un gr치fico vaciO, sin informaci칩n en sus ejes, ni representaciones gr치ficas de los datos. El siguiente paso es definir la est칠tica o aesthetics, mediante la funci칩n aes(), en la cual indicaremos cuales son las variables que constituir치n los ejes de nuestro gr치fico. En este caso construiremos un gr치fico con una sola variable, por lo que pondremos la edad en el eje x. 

Cada capa adicional que vayamos agregando a nuestro gr치fico en ggplot 2 debe agregarse mediante un "+". No confundir con el trabajo con el pipeline. 

```{r,message=FALSE,warning=F}
datos %>% 
  ggplot() + 
  aes(x = brecha)
```

Por 칰ltimo, necesitamos decirle a ggplot como representar nuestros datos en el eje se침alado mediante un geom, es decir, el objeto geom칠trico que se utilizar치 para representar los datos. Para esto hay m칰ltiple funciones que empiezan con "geom_", como geom_bar, geom_point o geom_line. En este caso queremos contruir un histograma as칤 que usaremos geom_histogram. 

```{r,message=FALSE,warning=F}
datos %>% 
  ggplot() + 
  aes(x = brecha) +
  geom_histogram()
```

Ya tenemos una visualizaci칩n b치sica. Ahora introduciremos algunos elementos adicionales para mejorar la apariencia de nuestro gr치fico.

- labs(): Se a침aden un t칤tulo, un subt칤tulo y una nota al pie (caption) para proporcionar contexto y citar la fuente de los datos. Esto mejora la comprensi칩n del gr치fico por parte del espectador.

theme_minimal(): Se aplica un tema minimalista al gr치fico para un aspecto limpio y moderno.

- labs(): Se a침aden un t칤tulo, un subt칤tulo y una nota al pie (caption) para proporcionar contexto y citar la fuente de los datos. Esto mejora la comprensi칩n del gr치fico por parte del espectador.  

- Al final utilizamos geom_vline para a침adir una linea roja punteada que indique la media de la variable. Ojo que esta tiene su propio aes que no corresponde al del resto del gr치fico. 

```{r,message=FALSE,warning=F}
ggplot(datos, aes(x = brecha)) +
  geom_histogram(
    binwidth = 5,                    # Ajusta el ancho de las barras
    fill = "#42affa",                # Color de relleno de las barras
    color = "white",                 # Color de borde de las barras
    alpha = 0.8                      # Transparencia de las barras
  )  +
  labs(
    x = "Brecha Salarial de G칠nero (%)",
    y = "Frecuencia",
    title = "Distribuci칩n de la Brecha Salarial de G칠nero por Comuna"
  ) +
  theme_minimal() +
  geom_vline(
    aes(xintercept = mean(datos$brecha)),
    color = "red",                   # Color de la l칤nea
    linetype = "dashed",             # Tipo de l칤nea (discontinua)
    size = 1                         # Grosor de la l칤nea
  )
```

Ahora veamos el ejemplo de un gr치fico bivariado. para esto debemos fijar una varaible en cada eje para las aesthetics. En este caso veremos la relaci칩n entre la brecha salarial de g칠nero y el los a침os de escolaridad promedio de una comuna. Para esto usaremos un gr치fiuco de dispersi칩n, construido a partir de geom_point().

```{r,message=FALSE,warning=F}
datos %>% 
ggplot(aes(x = brecha, y = prom_esc)) +
  geom_point(color = "#0073C2", size = 3, alpha = 0.7)
```

Como vemos el gr치fico tiene los a침os de escolaridad promedio en el eje x, y la brecha salarial de g칠nero media en el eje y.

```{r,message=FALSE,warning=F}
ggplot(datos, aes(x = brecha, y = prom_esc)) +
  geom_point(color = "#0073C2", size = 3, alpha = 0.7) +  # Puntos m치s grandes y ligeramente transparentes
 # geom_smooth(method = "lm", color = "red", linetype = "dashed", se = FALSE) +  # L칤nea de tendencia con estilo
  labs(
    x = "Brecha Salarial de G칠nero (%)",
    y = "Promedio de A침os de Escolaridad (2017)",
    title = "Relaci칩n entre Brecha Salarial de G칠nero y Promedio de A침os de Escolaridad"
  ) +
  theme_minimal()  # Tama침o base de letra aumentado
```

Por 칰ltimo agregamos las etiquetas del gr치fico y otros elementos est칠ticos para mejorar su presentaci칩n.

## Estad칤stica descriptiva y bivariada

### Varianza
Para el an치lisis de la relaci칩n entre dos variables 

La varianza mide la dispersi칩n de los datos respecto a la media. Se calcula usando la siguiente f칩rmula:

$$
Var(X) = \frac{1}{n-1} \sum_{i=1}^{n} (X_i - \bar{X})^2
$$

Donde:
- \( X_i \) son los valores de la variable,
- \( \bar{X} \) es la media de \( X \),
- \( n \) es el n칰mero de observaciones.

Vamos a calcular la varianza de la variable brecha:

```{r}
# Media de la variable
media_brecha <- mean(datos$brecha, na.rm = TRUE)

# C치lculo de la varianza manualmente
varianza_manual <- sum((datos$brecha - media_brecha)^2, na.rm = TRUE) / (length(datos$brecha) - 1)
varianza_manual

var(datos$brecha, na.rm = TRUE)
```

### Correlaci칩n

La correlaci칩n de Pearson entre dos variables洧녦y洧녧se calcula de la siguiente manera:
$$
r = \frac{1}{n-1} \sum \left( \frac{x_i - \bar{x}}{s_x} \right) \left( \frac{y_i - \bar{y}}{s_y} \right)
$$
Vamos a calcular manualmente la correlaci칩n entre la variable brecha y promedio de escolaridad:

```{r}
# Media de las variables
media_brecha <- mean(datos$brecha, na.rm = TRUE)
media_esc <- mean(datos$prom_esc, na.rm = TRUE)

# Desviaci칩n est치ndar de las variables
sd_brecha <- sd(datos$brecha, na.rm = TRUE)
sd_esc <- sd(datos$prom_esc, na.rm = TRUE)

# C치lculo de las desviaciones estandarizadas y del producto de las desviaciones estandarizadas
producto_estandarizado <- (datos$brecha - media_brecha) / sd_brecha * (datos$prom_esc - media_esc) / sd_esc

# Suma de los productos de las desviaciones estandarizadas
suma_productos <- sum(producto_estandarizado, na.rm = TRUE)

# N칰mero de observaciones
n <- sum(!is.na(datos$brecha) & !is.na(datos$prom_esc))

# C치lculo de la correlaci칩n manualmente
correlacion_manual <- suma_productos / (n - 1)

# Mostrar el resultado de la correlaci칩n manual
correlacion_manual

cor(datos$brecha, datos$prom_esc)
```

Para analizar la relaci칩n entre todas las variables num칠ricas de la base de datos (exceptuando la variable comuna), podemos construir una matriz de correlaciones:

```{r}
matriz_correlacion <- cor(datos[,-c(1,7)], use = "complete.obs")
matriz_correlacion
```

Por 칰ltimo, podemos usar el paquete corrplot para obtener una visualiaci칩n r치pida de las correlaciones en un conjunto de variables.   

```{r message=F}
# Instalar y cargar el paquete necesario
# install.packages("corrplot")
library(corrplot)

# Crear el correlograma
corrplot(matriz_correlacion, method = "number", tl.srt = 45, type = "upper")

```
